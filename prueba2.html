<script>

// Referencia a Firestore
const db = firebase.firestore();
const usuariosRef = db.collection('usuario');


// Buscar el usuario por su email
usuariosRef.where("email", "==", email).get()
  .then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const userData = doc.data();
      const nombre = userData.nombre;
      const telefono = userData.telefono;

      // Una vez que tengas los datos del usuario, consulta su historial
      obtenerHistorial(email, nombre, telefono);
    });
  })
  .catch((error) => {
    console.error("Error obteniendo el usuario: ", error);
  });

  function obtenerHistorialMedicamentos(nombre, email, telefono) {
    const historialRef = db.collection('historial');
    
    // Obtener todos los registros de medicamentos
    historialRef.get()
      .then((querySnapshot) => {
        let historialMedicamentos = [];
        
        querySnapshot.forEach((doc) => {
          historialMedicamentos.push(doc.data());
        });
  
        // Ahora generamos el PDF con los datos del usuario y los registros de medicamentos
        generarPDF(nombre, email, telefono, historialMedicamentos);
      })
      .catch((error) => {
        console.error("Error obteniendo el historial de medicamentos: ", error);
      });
  }
  
  function obtenerHistorialMedicamentos(nombre, email, telefono) {
    const historialRef = db.collection('historial');
    
    // Obtener todos los registros de medicamentos
    historialRef.where("Email", "==", email).get()
      .then((querySnapshot) => {
        let historialMedicamentos = [];
        
        querySnapshot.forEach((doc) => {
          const medicamentoData = doc.data();
          historialMedicamentos.push({
            nombre: medicamentoData.Nombre,
            descripcion: medicamentoData.Descripcion,
            sintomas: medicamentoData.Sintomas,
            efectosSecundarios: medicamentoData.Efectos_Secundarios,
            restricciones: medicamentoData.Restricciones,
            fecha: medicamentoData.Fecha
          });
        });
  
        // Ahora generamos el PDF con los datos del usuario y los registros de medicamentos
        generarPDF(nombre, email, telefono, historialMedicamentos);
      })
      .catch((error) => {
        console.error("Error obteniendo el historial de medicamentos: ", error);
      });
  }

  import { jsPDF } from "jspdf";

function generarPDF(nombre, email, telefono, historialMedicamentos) {
  const doc = new jsPDF();

  // Título del PDF
  doc.setFontSize(16);
  doc.text("Receta Médica", 10, 10);

  // Información del usuario
  doc.setFontSize(12);
  doc.text(`Nombre: ${nombre}`, 10, 20);
  doc.text(`Email: ${email}`, 10, 30);
  doc.text(`Teléfono: ${telefono}`, 10, 40);

  // Datos de los medicamentos
  doc.text("Historial de Medicamentos:", 10, 50);
  
  let startY = 60;
  historialMedicamentos.forEach((item, index) => {
    doc.text(`Medicamento ${index + 1}:`, 10, startY);
    doc.text(`Nombre: ${item.nombre}`, 10, startY + 10);
    doc.text(`Descripción: ${item.descripcion}`, 10, startY + 20);
    doc.text(`Síntomas: ${item.sintomas}`, 10, startY + 30);
    doc.text(`Efectos Secundarios: ${item.efectosSecundarios}`, 10, startY + 40);
    doc.text(`Restricciones: ${item.restricciones}`, 10, startY + 50);
    doc.text(`Fecha: ${item.fecha}`, 10, startY + 60);
    
    startY += 70;  // Ajustar el espacio entre cada medicamento
  });

  // Guardar el PDF
  doc.save("receta.pdf");
}


</script>
